<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script src="/socket.io/socket.io.js" defer></script>
  <script src="script.js" defer></script>
  <title>Document</title>


<style type="text/css">

    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 300px);
      grid-auto-rows: 300px;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
</style>

</head>

<body>
<div id="signDiv">
	Username: <input id="signDiv-username" type="text"></input><br>
	Password: <input id="signDiv-password" type="password"></input>
	<button id="signDiv-signIn">Sign In</button>
	<button id="signDiv-signUp">Sign Up</button>
</div>

<div id="gameDiv" style="display:none;">
	<canvas id="ctx" style="border:1px solid #000000;"></canvas>

	<div id="chat-text" style="width:500px; height:20%; overflow-y:scroll">
		<div>CHATBOX......</div>
	</div>

	<form id="chat-form">
		<input id="chat-input" type="text" style="width:500px"></input>
	</form>

</div>

<div id="video-grid"></div>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>
	var socket = io();

	//Signing

	var signDiv = document.getElementById('signDiv');
	var signDivUsername = document.getElementById('signDiv-username');
	var signDivSignIn = document.getElementById('signDiv-signIn');
	var signDivSignUp = document.getElementById('signDiv-signUp');
	var signDivPassword = document.getElementById('signDiv-password');

	let screenObj = window.screen;

	var STREAM = null;
	var ROOM_ID = "RMS"

	const videoGrid = document.getElementById('video-grid')
	// var myPeer = new Peer()
	const myVideo = document.createElement('video')

	myVideo.muted = true
	const peers = {}

	// width: 1800px; height: 800px;
	
	signDivSignIn.onclick = function(){
		socket.emit('signIn',{username:signDivUsername.value,password:signDivPassword.value});
	}
	signDivSignUp.onclick = function(){
		socket.emit('signUp',{username:signDivUsername.value,password:signDivPassword.value});
	}
	socket.on('signInResponse',function(data){
		if(data.success){
			// socket.emit('set_payer_name', {username:signDivUsername.value});

			navigator.mediaDevices.getUserMedia({
				video: true,
				audio: true
				}).then(stream => {
					STREAM = stream;
					console.log("Inside media devices: " + stream)
				addVideoStream(myVideo, stream, videoGrid)

				// myVideo.srcObject = stream
			 //    myVideo.addEventListener('loadedmetadata', () => {
			 //      console.log("Got here!!!!!")
			 //      myVideo.play()
			 //    })
			 //    console.log("Adding video:" + myVideo + "video grid:" + videoGrid)
			 //    videoGrid.append(myVideo)


				const myPeer = new Peer(undefined, {
					host: '/',
					port: '3001'
				})

				socket.on('user-connected', userId => {
					console.log("user-connected : User ID" + userId)

					connectToNewUser(userId, stream, myPeer, videoGrid);
					// console.log("Inside connectnewuser, " + userId + " : " + stream + " : " + myPeer)
					// const call = myPeer.call(userId, stream)
					// const video = document.createElement('video')
					// console.log("connect a new user:" + userId)
					// call.on('stream', userVideoStream => {
					//     addVideoStream(video, userVideoStream, videoGrid)

					    // video.srcObject = userVideoStream
					    // video.addEventListener('loadedmetadata', () => {
					    //   console.log("Got here!!!!!")
					    //   video.play()
					    // })
					    // console.log("Adding video:" + video + "video grid:" + videoGrid)
					    // videoGrid.append(video)

					// })
					// call.on('close', () => {
					//     video.remove()
					// })

					// peers[userId] = call
					// connectToNewUser(userId, STREAM, myPeer)
				})

				myPeer.on('open', id => {
					console.log("join room called for " + ROOM_ID + ":" + id)
					socket.emit('join-room', ROOM_ID, id, signDivUsername.value)
				})

				myPeer.on('call', call => {
					call.answer(stream)
					console.log("connecting stream object:" + stream)
					const video = document.createElement('video')
					call.on('stream', userVideoStream => {
						addVideoStream(video, userVideoStream, videoGrid)
					})
				})
			})


			// socket.emit('join-room', {roomId:ROOM_ID, userId: signDivUsername.value});
			// socket.emit('join-room', ROOM_ID, signDivUsername.value)

			signDiv.style.display = 'none';
			gameDiv.style.display = 'inline-block';		//Equivalent of visible
			var cc = document.getElementById("ctx")
			cc.width  = window.innerWidth*90/100;
			cc.height = window.innerHeight*75/100;

		} else
			alert("Invalid Username or Password.");
	});
	// setTimeout(function(){return 0}, 2000);


	socket.on('user-disconnected', userId => {
	if (peers[userId]) peers[userId].close()
	})



	function connectToNewUser(userId, stream, myPeer, videoGrid) {
	  console.log("Inside connectnewuser, " + userId + " : " + stream + " : " + myPeer)
	  const call = myPeer.call(userId, stream)
	  const video = document.createElement('video')
	  console.log("connect a new user:" + userId)
	  call.on('stream', userVideoStream => {
	    addVideoStream(video, userVideoStream, videoGrid)
	  })
	  call.on('close', () => {
	    video.remove()
	  })

	  peers[userId] = call
	}

	function addVideoStream(video, stream, videoGrid) {
	  video.srcObject = stream
	  video.addEventListener('loadedmetadata', () => {
	    console.log("Got here!!!!!")
	    video.play()
	  })
	  console.log("Adding video:" + video + "video grid:" + videoGrid)
	  videoGrid.append(video)
	}





	socket.on('signUpResponse',function(data){
		if(data.success){
			alert("Sign up successul.");
		} else
			alert("Username already in use!!");
	});

	socket.on('getShape', function(data){
		// ROOM_ID = data.roomId;
		console.log("Rooooooom Id:" + ROOM_ID);
		socket.emit('window_shape', {height: window.innerHeight*75/100, width: window.innerWidth*90/100});
	});



	// Gameplay
	var chatText = document.getElementById('chat-text');
	var chatInput = document.getElementById('chat-input');
	var chatForm = document.getElementById('chat-form');

	var ctx = document.getElementById("ctx").getContext("2d");
	ctx.font = '30px Arial';

	socket.on('newPositions', function(data){
		ctx.clearRect(0, 0, window.innerWidth*90/100, window.innerHeight*75/100);

		for (var i = 0; i < data.player.length; i++) {
			ctx.fillText(data.player[i].number, data.player[i].x, data.player[i].y);
		}
	});

	socket.on('addToChat',function(data){
		chatText.innerHTML += '<div>' + data + '</div>';
	});

	socket.on('vicinity', function(p){
		console.log("Player " + p + " is in vicinity");
	});

	chatForm.onsubmit = function(e){
		e.preventDefault();				// Prevent refreshing of page
		socket.emit('sendMsgToServer',{username: signDivUsername.value, msg:chatInput.value});
		chatInput.value = '';		
	}

	document.onkeydown = function(event){
		if(event.keyCode == 39) //d
			socket.emit('keyPress', {inputId:'right', state:true});
		else if(event.keyCode == 40) //s
			socket.emit('keyPress', {inputId:'down', state:true});
		else if(event.keyCode == 37) //a
			socket.emit('keyPress', {inputId:'left', state:true});
		else if(event.keyCode == 38) //w
			socket.emit('keyPress', {inputId:'up', state:true});
	}

	document.onkeyup = function(event){
		if(event.keyCode == 39) //d
			socket.emit('keyPress', {inputId:'right', state:false});
		else if(event.keyCode == 40) //s
			socket.emit('keyPress', {inputId:'down', state:false});
		else if(event.keyCode == 37) //a
			socket.emit('keyPress', {inputId:'left', state:false});
		else if(event.keyCode == 38) //w
			socket.emit('keyPress', {inputId:'up', state:false});
	}

</script>
</body>
</html>