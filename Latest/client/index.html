<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script>
    const ROOM_ID = "RMS"
  </script>
  <script src="https://unpkg.com/peerjs@1.2.0/dist/peerjs.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="script.js"></script>
  <title>Document</title>


<style type="text/css">

    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 300px);
      grid-auto-rows: 300px;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
</style>

</head>

<body>
<div id="signDiv">
	Username: <input id="signDiv-username" type="text"></input><br>
	Password: <input id="signDiv-password" type="password"></input>
	<button id="signDiv-signIn">Sign In</button>
	<button id="signDiv-signUp">Sign Up</button>
</div>

<div id="gameDiv" style="display:none;">
	<canvas id="ctx" style="border:1px solid #000000;"></canvas>

	<div id="chat-text" style="width:500px; height:20%; overflow-y:scroll">
		<div>CHATBOX......</div>
	</div>

	<form id="chat-form">
		<input id="chat-input" type="text" style="width:500px"></input>
	</form>

</div>

<div id="video-grid"></div>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>
	var socket = io();

	//Signing

	var signDiv = document.getElementById('signDiv');
	var signDivUsername = document.getElementById('signDiv-username');
	var signDivSignIn = document.getElementById('signDiv-signIn');
	var signDivSignUp = document.getElementById('signDiv-signUp');
	var signDivPassword = document.getElementById('signDiv-password');

	let screenObj = window.screen;

	var STREAM = null;

	const videoGrid = document.getElementById('video-grid')
	const myPeer = new Peer(undefined, {
		host: '/',
		port: '3001'
	})
	const myVideo = document.createElement('video')

	myVideo.muted = true
	const peers = {}

	// width: 1800px; height: 800px;
	
	signDivSignIn.onclick = function(){
		socket.emit('signIn',{username:signDivUsername.value,password:signDivPassword.value});
	}
	signDivSignUp.onclick = function(){
		socket.emit('signUp',{username:signDivUsername.value,password:signDivPassword.value});
	}
	socket.on('signInResponse',function(data){
		if(data.success){
			// socket.emit('set_payer_name', {username:signDivUsername.value});

			navigator.mediaDevices.getUserMedia({
				video: true,
				audio: true
				}).then(stream => {
					STREAM = stream;
					console.log("Inside media devices: " + stream)
				addVideoStream(myVideo, stream, videoGrid)
			})


			// socket.emit('join-room', {roomId:ROOM_ID, userId: signDivUsername.value});
			signDiv.style.display = 'none';
			gameDiv.style.display = 'inline-block';		//Equivalent of visible
			var cc = document.getElementById("ctx")
			cc.width  = window.innerWidth*90/100;
			cc.height = window.innerHeight*75/100;

		} else
			alert("Invalid Username or Password.");
	});
	setTimeout(function(){return 0}, 2000);

	myPeer.on('call', call => {
		call.answer(STREAM)
		console.log("connecting stream object:" + STREAM)
		const video2 = document.createElement('video')
		call.on('stream', userVideoStream => {
			addVideoStream(video2, userVideoStream, videoGrid)
		})
	});

	myPeer.on('open', id => {
		console.log("join room called for " + ROOM_ID + ":" + id)
		socket.emit('join-room', ROOM_ID, id)
	});

	socket.on('user-connected', userId => {
		console.log("user-connected : User ID" + userId)
		connectToNewUser(userId, STREAM, myPeer)
	})

	socket.on('user-disconnected', userId => {
	if (peers[userId]) peers[userId].close()
	})


	socket.on('signUpResponse',function(data){
		if(data.success){
			alert("Sign up successul.");
		} else
			alert("Username already in use!!");
	});

	socket.on('getShape', function(data){
		socket.emit('window_shape', {height: window.innerHeight*75/100, width: window.innerWidth*90/100});
	});



	// Gameplay
	var chatText = document.getElementById('chat-text');
	var chatInput = document.getElementById('chat-input');
	var chatForm = document.getElementById('chat-form');

	var ctx = document.getElementById("ctx").getContext("2d");
	ctx.font = '30px Arial';

	socket.on('newPositions', function(data){
		ctx.clearRect(0, 0, window.innerWidth*90/100, window.innerHeight*75/100);

		for (var i = 0; i < data.player.length; i++) {
			ctx.fillText(data.player[i].number, data.player[i].x, data.player[i].y);
		}
	});

	socket.on('addToChat',function(data){
		chatText.innerHTML += '<div>' + data + '</div>';
	});

	socket.on('vicinity', function(p){
		console.log("Player " + p + " is in vicinity");
	});

	chatForm.onsubmit = function(e){
		e.preventDefault();				// Prevent refreshing of page
		socket.emit('sendMsgToServer',{username: signDivUsername.value, msg:chatInput.value});
		chatInput.value = '';		
	}

	document.onkeydown = function(event){
		if(event.keyCode == 39) //d
			socket.emit('keyPress', {inputId:'right', state:true});
		else if(event.keyCode == 40) //s
			socket.emit('keyPress', {inputId:'down', state:true});
		else if(event.keyCode == 37) //a
			socket.emit('keyPress', {inputId:'left', state:true});
		else if(event.keyCode == 38) //w
			socket.emit('keyPress', {inputId:'up', state:true});
	}

	document.onkeyup = function(event){
		if(event.keyCode == 39) //d
			socket.emit('keyPress', {inputId:'right', state:false});
		else if(event.keyCode == 40) //s
			socket.emit('keyPress', {inputId:'down', state:false});
		else if(event.keyCode == 37) //a
			socket.emit('keyPress', {inputId:'left', state:false});
		else if(event.keyCode == 38) //w
			socket.emit('keyPress', {inputId:'up', state:false});
	}

</script>
</body>
</html>